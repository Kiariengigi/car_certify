import React, { useState } from 'react';
import '../Styles/Step_Three.css';

const StepThree = ({ size = '50%', className = '', onDataChange, data, setData }) => {
  const [activePart, setActivePart] = useState(null);
  const [tooltip, setTooltip] = useState({ visible: false, x: 0, y: 0 });
  const [severities, setSeverities] = useState({});
  const [newDamage, setNewDamage] = useState({ date: '', severity: '', location: '' });
  const [loggedDamages, setLoggedDamages] = useState([]); // New state for summary

  const handleDamageChange = (field, value) => {
    setNewDamage(prev => ({ ...prev, [field]: value }));
  };

 const handleSubmit = e => {
  e.preventDefault();
  if (!newDamage.date || !newDamage.severity || !newDamage.location) return;

  const entry = {
    id: Date.now(),
    date: newDamage.date,
    severity: newDamage.severity,
    location: newDamage.location
  };

  // Update child local summary
  setLoggedDamages(prev => [...prev, entry]);

  // **Update parent**
  setData(prev => ({
    ...prev,
    accidentReports: [...prev.accidentReports, entry]
  }));

  setNewDamage({ date: '', severity: '', location: '' });
};



  const severityColors = {
    Minor_Damage: '#08CB00',
    Functional_Damage: '#CFFF04',
    Disabling_Damage: '#FFA239',
    Write_Off: '#F93827'
  };

  const PartGroup = ({ id, children }) => {
    const severity = severities[id];
    const color = severity ? severityColors[severity] : (activePart === id ? 'black' : 'black');
    const glow =
      severity === 'Minor Damage'
        ? '0 0 8px #08CB00'
        : severity === 'Functional Damage'
        ? '0 0 12px #CFFF04'
        : severity === 'Disabling Damage'
        ? '0 0 16px #FFA239'
        : severity === 'Write-off'
        ? '0 0 20px #F93827'
        : 'none';

    const styles = {
      cursor: 'pointer',
      stroke: color,
      strokeWidth: activePart === id ? 4 : 2,
      opacity: activePart && activePart !== id ? 0.3 : 1,
      filter: glow ? `drop-shadow(${glow})` : 'none',
      transition: 'all 0.3s ease'
    };

    const handleClick = e => {
      e.stopPropagation();
      setActivePart(id);
      setTooltip({ visible: true, x: e.clientX, y: e.clientY });
      setNewDamage(prev => ({ ...prev, location: id }));
    };

    return (
      <g onClick={handleClick} style={styles}>
        <g stroke="transparent" strokeWidth={30} fill="none">
          {children}
        </g>
        {children}
      </g>
    );
  };

  const handleSeveritySelect = level => {
    setSeverities(prev => ({ ...prev, [activePart]: level }));
    setNewDamage(prev => ({ ...prev, severity: level }));
    setTooltip(prev => ({ ...prev, visible: false }));
  };

  const handleRemoveDamage = id => {
  const removed = loggedDamages.find(d => d.id === id);

  setLoggedDamages(prev => prev.filter(d => d.id !== id));

  // Remove from parent
  if (removed) {
    setData(prev => ({
      ...prev,
      accidentReports: prev.accidentReports.filter(d => d.id !== id)
    }));
  }

  if (removed?.location) {
    setSeverities(prev => {
      const newSeverities = { ...prev };
      delete newSeverities[removed.location];
      return newSeverities;
    });
  }
};

  return (
    <div className={`relative ${className}`} onClick={() => setActivePart(null)}>
      {tooltip.visible && (
        <div
          style={{
            position: 'fixed',
            top: tooltip.y + 10,
            left: tooltip.x + 10,
            background: 'white',
            padding: '8px',
            border: '1px solid #ccc',
            borderRadius: '4px',
            zIndex: 1000
          }}
        >
          <div className="mb-1 font-bold">Select Severity</div>
          {['Minor damage', 'Functional damage', 'Disabling damage', 'Write off'].map(level => (
            <div key={level} style={{ display: 'inline-block', margin: '2px' }}>
              <button
                onClick={() => handleSeveritySelect(level)}
                className="px-2 py-1 rounded"
                style={{ backgroundColor: severityColors[level], color: 'white' }}
                 value={newDamage.severity}
                  onChange={(e) => handleDamageChange('severity', e.target.value)}
              >
                {level.toUpperCase()}
              </button>
            </div>
          ))}
        </div>
      )}

      <div className="absolute top-0 left-0 p-4 pointer-events-none">
        <h3 className="text-lg font-bold text-white-800 bg-white/80 backdrop-blur px-2 rounded">
          {activePart ? activePart.toUpperCase() : 'SELECT ZONE'}
        </h3>
      </div>

      {/* Form for date input */}
      <form onSubmit={handleSubmit} className="absolute bottom-4 left-4 bg-white p-3 rounded shadow">
        <input
          type="date"
          value={newDamage.date}
          onChange={e => handleDamageChange('date', e.target.value)}
          className="border px-2 py-1 rounded mr-2"
          required
        />
        <button type="submit" className="bg-blue-500 text-white px-3 py-1 rounded">
          Add Damage
        </button>
      </form>

      {/* Summary panel */}
      <div className="absolute bottom-4 right-4 bg-white p-4 rounded shadow max-h-64 overflow-y-auto w-80">
        <h4 className="font-bold mb-2">Damage Summary</h4>
        {loggedDamages.length === 0 ? (
          <p className="text-gray-500">No damages logged yet.</p>
        ) : (
          <ul>
            {loggedDamages.map(d => (
              <li key={d.id} className="mb-1">
                <span className="font-semibold">{d.location.toUpperCase()}</span> — {d.date} —{' '}
                <span style={{ color: severityColors[d.severity] }}>{d.severity.toUpperCase()}</span>
                <button
            onClick={() => handleRemoveDamage(d.id)}
            className="ml-2 bg-red-500 text-white px-2 py-0.5 rounded text-xs"
          >
            Remove
          </button>
              </li>
            ))}
          </ul>
        )}
      </div>

      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 1108 564.5"
        width={size}
        height={size}
        fill="none"
        strokeLinecap="round"
        strokeLinejoin="round"
        onClick={() => setActivePart(null)}
      >

        {/* --- FRONT (Nose, Hood, Front Wheel) --- */}
        <PartGroup id="Front" activePart={activePart} onSelect={setActivePart}>
          <path d="M162.94,128.93c-16.06,18.99-24.18,42.1-31.06,65.15-11.36,38.07-16.52,77.45-14.11,117.19,3.18,52.58,15.02,103.02,42.85,148.69"/>
          <path d="M88.45,139.38c-9.48,9.24-12.49,21.3-15.22,33.66-3.1,14.03-7.69,27.75-10.23,41.86-6.77,37.64-12.32,75.43-5.98,113.8,3.9,23.61,7.01,47.39,11.9,70.8,3.45,16.55,13.93,29.47,26.43,40.79,6.28,5.69,11.72,12.3,17.54,18.5"/>
          <path d="M494.64,92.92c-48.89-.43-97.82,3.9-146.66-2.18-16.57-2.06-33.33-2.79-50.03-3.55-23.65-1.08-47.32-2.06-70.99-2.24-14.35-.11-28.75,2.5-43.05,1.9-21.37-.9-41.03,4.19-59.27,14.37-15.32,8.55-27.82,20.45-35.62,36.52l23.89-7.65"/>
          <path d="M174.58,91.76c32.39,27.01,69.38,44.66,110.59,53.34,18.9,3.99,38,7.05,57.01,10.54"/>
          <path d="M318.9,83.63c-22.5-2.71-45.03-7.76-67.5-7.5-24.09,.28-48.11,5.56-72.17,8.66"/>
          <path d="M396.88,155.64c-5.04,.39-10.08,.88-15.13,1.14-15.9,.83-31.85,2.64-47.71,2.12-34.64-1.13-68.67-7.28-102.42-14.9-28.73-6.49-57.2-14.61-86.24-18.99-11.32-1.71-24.45-1.4-35.4,10.33-11.96,12.82-25.65,24.05-35.48,38.88"/>
          <path d="M359.63,124.28c-11.25,2.32-22.5,4.63-33.75,6.98-3.5,.73-6.98,1.54-10.48,2.32"/>
          <path d="M378.26,120.8h31.34c-4.44,12.05-8,21.71-11.56,31.36"/>
          <path d="M422.48,116.15c-3.1,12.39-6.21,24.78-9.31,37.17"/>
          <path d="M439.94,117.31c-8.81,7.68-8.31,19.46-12.62,29.12-.24,.54,2.15,2.24,3.31,3.4"/>
          <path d="M443.43,114.99l-48.88,3.48"/>
          <path d="M469.04,113.83h-23.28"/>
          <path d="M469.04,116.15h-23.28"/>
          <path d="M492.32,148.67h-20.95"/>
          <path d="M375.93,151h-18.62"/>
          <path d="M375.93,148.67h-18.62"/>
          <path d="M420.16,96.41c-4.54,6.14-2.82,11.85,1.16,17.42"/>
          <path d="M392.22,121.96c-4.66,.39-9.31,.77-13.97,1.16"/>
          <path d="M375.93,121.96c-4.66,.39-9.31,.77-13.97,1.16"/>
          <path d="M373.6,124.28c-3.88,.39-7.76,.77-11.64,1.16"/>
          <path d="M334.03,148.67h11.64"/>
          <path d="M304.93,135.9c3.35,3.41,6.49,7.88,11.67,2.34-1.97-7.63-6.5-6.64-11.67-3.51"/>
          <path d="M336.36,145.19c3.1,.39,6.21,.77,9.31,1.16"/>
          <path d="M168.76,88.28h11.64"/>
        </PartGroup>

        {/* --- REAR (Bed, Tailgate, Rear Wheel) --- */}
        <PartGroup id="Rear" activePart={activePart} onSelect={setActivePart}>
          <path d="M1017.22,400.72c-64.88,35.64-132.07,65.18-204.77,81.6-32.73,7.39-64.1,4.87-95.51-4.94-2.84-.89-5.71-1.7-8.57-2.55-.25,1.24-.5,2.47-.74,3.71h6.98"/>
          <path d="M1017.22,188.17c-58.39-31.24-118.54-57.82-182.56-76.1-28.01-8-55.7-12.64-83.89-8.17-22.53,3.58-44.36,11.68-66.4,18.15-8.7,2.55-17.1,6.11-25.63,9.2"/>
          <path d="M1020.71,193.97c15.03,39.77,18.55,81.22,16.01,123.1-1.53,25.27-6.27,50.19-14.6,74.44-5.52,16.05-10.23,32.25-20.03,46.38"/>
          <path d="M925.27,90.6c3.91,16.66,16.68,26.13,29.06,36.06,15.68,12.58,31.74,24.8,46.31,38.58,7.31,6.91,21.43,10.27,17.74,25.26,25.75,27.58,24.38,62.32,25.62,96.41,1.15,31.61-1.15,62.83-11.84,92.86-2.23,6.26-6.8,11.68-10.29,17.49"/>
          <path d="M1012.56,414.66c-5.04,4.26-10.09,8.51-15.13,12.78-12.8,10.84-24.75,22.96-38.63,32.19-16.44,10.94-30.31,23.15-35.46,40.77-19.06,1.31-36.49,3.36-53.94,3.51-31.42,.28-62.88,.1-94.26-1.26-15.98-.69-31.82-4.41-47.74-6.6-1.47-.2-3.09,.7-4.64,1.08"/>
          <path d="M917.13,83.63c-21.97-7.46-44.96-5.86-67.52-6.66-25.95-.92-52.1-.96-77.92,1.38-16.16,1.46-31.86,8-47.77,12.26"/>
          <path d="M1012.56,173.07c-2.93-14.72-12.15-26.2-22.41-35.69-17.56-16.24-36.31-31.42-55.92-45.12-6.72-4.69-17.46-4.7-26.42-4.96-41.5-1.2-83.02-2.17-124.53-2.26-13.57-.03-27.14,3.05-40.74,4.34-14.72,1.4-29.48,2.35-44.22,3.57-1.96,.16-3.88,.74-5.82,1.13"/>
          <path d="M933.42,109.18c-17.46-.77-34.92-1.51-52.37-2.35-4.28-.21-8.53-.98-12.8-1.09-17.46-.48-34.91-.81-52.37-1.2"/>
          <path d="M946.22,489c-7.37,3.87-14.74,7.74-22.11,11.62"/>
          <path d="M997.43,442.54c-14.74,13.94-29.48,27.88-44.23,41.81"/>
        </PartGroup>

        {/* --- LEFT (Cabin Body, Doors, Side Steps) --- */}
        <PartGroup id="Left" activePart={activePart} onSelect={setActivePart}>
          <path d="M662.24,133.57c20.56-5.42,41.11-10.87,61.69-16.24,4.54-1.18,9.16-2.06,13.57-3.04,12.47,18.57,18,37.89,22.49,57.6,13.47,59.08,9.98,119.17,8.73,178.86-.79,37.27-6.71,74.58-22.83,109.13-2.72,5.83-7.33,10.79-10.65,15.56-34.56-9.79-67.19-18.96-99.76-28.29-21.34-6.11-42.7-10.32-65.14-12.16-65.51-5.37-131-10.17-196.73-8.44-22.16,.58-44.28,4.03-66.34,6.79-21.01,2.64-42.04,5.41-62.82,9.38-21.89,4.19-43.61,9.42-65.18,15.02-30.44,7.91-60.12,9.39-88.48-7.08"/>
          <path d="M591.24,154.48c1.16,12,2.13,24.03,3.54,36,2.15,18.22,6.34,36.38,6.57,54.6,.46,35.99-.54,72.04-2.21,108-.95,20.58-4.49,41.04-6.69,61.58-.7,6.55-.82,13.16-1.21,19.74"/>
          <path d="M678.53,106.86c4.95-1.97,9.9-3.95,14.85-5.92,.16-1.28,.33-2.56,.49-3.85-11.32-9.13-22.33-18.7-34.16-27.12-3.28-2.33-8.99-1.27-16.04-2.03,4.44,9.74,7.39,16.22,10.89,23.92-3.48,.38-6.63,.99-9.78,1.02-45.39,.45-90.78,.94-136.17,.99-4.27,0-8.53-2.91-12.81-4.43-2.31-.82-4.6-1.8-6.99-2.29-15.21-3.15-30.48-6.41-44.22,4.61"/>
          <path d="M445.76,497.13c1.16-.39,2.33-1.11,3.49-1.11,65.95-.05,131.9-.06,197.86-.01,2.32,0,4.63,.54,7.14,.86-2.98,7.19-5.85,14.1-9.09,21.91,24.41,5.46,32.08-17.3,47.1-25.11-.31-6.23-.56-11.28-.92-18.37,3.4,.77,6.36,1.43,9.31,2.1"/>
          <path d="M473.69,160.29c-19.01,.39-38.02,1.11-57.03,1.08-23.67-.04-47.33-.69-71-1.08"/>
          <path d="M496.97,498.29c-17.68,9.56-34.66,10.09-52.67-.67-5.88-3.52-15.25-1.88-22.98-1.55-29.88,1.28-59.81,2.28-89.59,4.87-12.59,1.09-24.72,6.81-37.31,8.7-13.01,1.95-26.41,3.04-39.52,2.33-26.43-1.45-52.78-4.36-79.15-6.79-1.23-.11-2.43-1.37-3.42-2.32-.19-.18,.69-1.46,1.08-2.24"/>
          <path d="M555.16,473.9h-88.45"/>
          <path d="M555.16,476.22h-88.45"/>
          <path d="M523.74,155.64c-7.37,.39-14.88,1.86-22.09,.97-31.39-3.85-62.78-3.69-94.31-2.44-9.62,.38-19.39-2.8-29.08-4.35"/>
          <path d="M655.26,112.67h-76.82"/>
          <path d="M631.98,138.22c-25.48,4.84-50.97,9.68-76.02,14.43-.25-.3,.64,.76,1.53,1.83"/>
          <path d="M672.71,478.54c1.3-4.45,2.6-8.89,4.35-14.87-5.24,.65-11.69,1.46-20.16,2.52,2.36-2.96,3.22-4.05,4.68-5.88-25.54-5.49-49.05-18.8-75.7-17.57l-.61,2.68c5.09,1.36,10.19,2.72,15.28,4.08"/>
          <path d="M531.89,112.67c-20.17,.77-40.35,1.55-60.52,2.32"/>
          <path d="M615.68,477.38c-19.4-.77-38.8-1.55-58.19-2.32"/>
          <path d="M656.42,124.28c-19.01,4.65-38.02,9.29-57.03,13.94-3.11,.76-6.21,1.55-9.31,2.32"/>
          <path d="M689.01,484.35c-18.99-6.67-38.71-4.11-58.19-4.68-4.28-.13-8.54-.74-12.8-1.12"/>
          <path d="M429.47,439.05c0,2.71-.53,5.55,.1,8.11,1.86,7.48,4.18,14.85,6.39,22.5,6.67,.67,12.9,1.29,19.12,1.91"/>
          <path d="M384.08,434.41h-42.73c-.38,11.1-11.72,7.85-16.62,12.78"/>
          <path d="M634.31,141.7c-12.8,3.48-25.57,7.12-38.43,10.38-4.92,1.25-10.05,2.1-15.11,2.31-15.51,.63-31.03,.86-46.55,1.25"/>
          <path d="M576.11,113.83h-41.9"/>
          <path d="M576.11,111.51h-41.9"/>
          <path d="M618.01,476.22c14.01-.7,28.01-1.4,43.02-2.14-2.99-12.15-13.37-9.65-19.89-12.65-7.13-3.29-15.38-4.18-23.14-6.12"/>
          <path d="M412.01,435.57c3.42,11.25,6.84,22.5,9.11,29.96-.89,11.79-1.51,19.95-2.13,28.12"/>
          <path d="M587.75,139.38c-2.33,0-5.67-1-6.82,.16-7.14,7.22-16.03,5.51-24.61,5.64"/>
          <path d="M406.19,471.58c16.29,.77,32.59,1.55,48.88,2.32"/>
          <path d="M529.56,147.51c-7.76-.39-15.52-.77-23.28-1.16"/>
          <path d="M531.89,144.03c7.35-.46,14.7-.92,22.11-1.38,.03,5.11-1.94,5.9-23.85,10.8v-5.94h23.86"/>
          <path d="M400.37,441.38c2.25,8.78,9.19,16.75,4.66,26.71"/>
          <path d="M528.39,149.84c-7.37-.39-14.74-.77-22.11-1.16"/>
          <path d="M573.79,141.7c-6.46-1.21-13.07-3.66-18.62,2.32"/>
          <path d="M528.39,154.48c-7.55,5.33-15.74,6.2-24.44,3.48"/>
          <path d="M650.6,137.06c-5.43,.77-10.86,1.55-16.29,2.32"/>
          <path d="M567.97,446.02h-15.13"/>
          <path d="M687.84,468.09c6.98,1.94,13.97,3.87,20.95,5.81"/>
          <path d="M665.73,483.19c-3.1,3.87-6.21,7.74-9.31,11.62"/>
          <path d="M655.26,92.92c2.72,3.87,5.43,7.74,8.15,11.62"/>
          <path d="M690.17,477.38c-3.49,.39-6.98,.77-10.47,1.16"/>
          <path d="M676.21,108.02c-.78,3.48-1.55,6.97-2.33,10.45"/>
          <path d="M599.39,452.99h9.31"/>
          <path d="M657.58,131.25c-2.77,.42-5.53,.84-8.3,1.27,.13,1.1,.26,2.21,.38,3.31,3.42-.36,6.84-.69,10.24-1.14,.43-.06,.78-.73,1.17-1.12-.39-.39-.78-.77-1.16-1.16"/>
          <path d="M679.7,465.77c1.94,1.16,3.88,2.32,5.82,3.48"/>
          <path d="M648.27,133.57c-4.66,1.16-9.32,2.3-13.96,3.52-.46,.12-1.09,.74-1.09,1.13,0,.39,.69,.77,1.08,1.16"/>
          <path d="M694.83,479.71c4.27-.39,8.53-.77,12.8-1.16"/>
          <path d="M657.58,113.83l5.67,2.48h-4.35c-.83,1.87-1.66,3.76-2.49,5.65"/>
        </PartGroup>

        {/* --- RIGHT (Mapped to: FRAME / UNDERCARRIAGE) --- */}
        <PartGroup id="Right" activePart={activePart} onSelect={setActivePart}>
          {/* Main Chassis Rail Top */}
          <path d="M730.91,124.28c-31.81,8.52-63.65,16.93-95.42,25.61-11.72,3.2-23.26,7.02-36.4,11.02,16.02,88.5,16.59,177.55-.15,267.26,44.51,12.66,88.79,25.25,133.91,38.09,11.47-17.1,15.94-36.75,20.02-56.27,10.34-49.43,10.9-99.67,9.14-149.79-1.37-38.91-5.25-77.81-18.46-114.94-2.76-7.75-7.6-14.77-11.48-22.13"/>
          {/* Main Chassis Rail Bottom */}
          <path d="M167.6,451.83c30.67-7.27,61.34-14.54,91.58-21.71-27.35-90.57-27.48-180.78-.03-271.25-29.96-7.05-60.37-14.2-92.78-21.82-10.52,11.3-15.09,28.18-20.68,44.21-9.29,26.62-16.16,53.86-16.59,82.4-.24,15.88-3.01,31.85-1.94,47.6,3.37,49.8,13.2,98.07,39.28,141.72"/>
          {/* Structural Crossmembers & Axles */}
          <path d="M662.24,133.57c20.56-5.42,41.11-10.87,61.69-16.24,4.54-1.18,9.16-2.06,13.57-3.04,12.47,18.57,18,37.89,22.49,57.6,13.47,59.08,9.98,119.17,8.73,178.86-.79,37.27-6.71,74.58-22.83,109.13-2.72,5.83-7.33,10.79-10.65,15.56-34.56-9.79-67.19-18.96-99.76-28.29-21.34-6.11-42.7-10.32-65.14-12.16-65.51-5.37-131-10.17-196.73-8.44-22.16,.58-44.28,4.03-66.34,6.79-21.01,2.64-42.04,5.41-62.82,9.38-21.89,4.19-43.61,9.42-65.18,15.02-30.44,7.91-60.12,9.39-88.48-7.08"/>
          <path d="M274.67,154.48c-14.33,16.72-18.89,37.69-21.6,58.14-3.95,29.93-5.88,60.33-5.95,90.53-.09,36.11,1.89,72.39,14.89,106.81,3.35,8.86,8.4,17.09,12.66,25.61"/>
          <path d="M692.5,494.81c22.88-.74,43.08,11,65.18,13.93,8.92,1.18,17.83,3.2,26.77,3.33,29.48,.42,59.02,1.23,88.43-.27,15.61-.8,32.33,.58,46.58-8.86"/>
          <path d="M338.68,435.57c-31.87,1.62-61.9,10.71-92.08,20.5-27.76,9-50.33,25.12-72.03,43.39"/>
          <path d="M342.18,440.21c19.33,.28,38.15-1.95,57.2-6.19,10.59-2.36,23.63-4.43,34.83,2.56,1.67,1.04,4.57,.05,6.89,.16,33.37,1.53,66.73,3.14,100.09,4.59,6.97,.3,14.04-.56,20.91,.31,3.3,.42,6.24,3.61,9.34,5.55"/>
          <path d="M317.74,454.15c12.23,7.19,26.29,6.7,39.59,9.17,15.42,2.86,31.01,4.77,46.53,7.09"/>
          <path d="M315.41,447.18c-4.02,1.59-8.04,3.18-12.05,4.77-.03,1.02-.07,2.04-.1,3.06,4.83,.88,9.65,1.75,14.48,2.63"/>
          <path d="M320.06,449.51c1.21-.7,2.41-1.41,3.79-2.22-1.33-1.05-2.42-1.92-3.55-2.81-2.58,3.86-4.91,7.35-7.23,10.83"/>
          <path d="M74.49,416.98c1.16,5.03,1.55,10.41,3.62,15.04,12.53,28.12,30.52,51.56,60.51,62.47,10.55,3.84,22.39,4.18,33.64,6.11"/>
          <path d="M711.12,108.02c0,.39,.09,1.09-.01,1.12-12.79,3.53-26,6-38.24,10.88-7.34,2.92-13.64,4.74-21.17,2.15-1.03-.35-3.03,2.11-4.58,3.28"/>
          <path d="M758.84,106.86c-5.82,3.87-11.64,7.74-17.46,11.62"/>
        </PartGroup>

      </svg>
    </div>
  );
};

export default StepThree;
